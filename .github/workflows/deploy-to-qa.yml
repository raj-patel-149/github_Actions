name: Deploy to Salesforce QA

on:
  push:
    branches: [main]

# permissions:
#   contents: write
#   pull-requests: write

jobs:
  deploy-to-qa:
    name: Deploy Changed Metadata Only
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (last 2 commits only)
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf --version || true

      - name: Create JWT Key File
        run: echo "${{ secrets.SF_JWT_KEY }}" > server.key

      - name: Authenticate to Salesforce
        run: |
          echo "Logging in with JWT..."
          if ! sf org login jwt \
            --client-id ${{ secrets.SF_CLIENT_ID }} \
            --jwt-key-file server.key \
            --username ${{ secrets.SF_USERNAME_QA }} \
            --alias QA \
            --instance-url https://login.salesforce.com; then
            echo "sf CLI failed, falling back to sfdx..."
            sfdx auth:jwt:grant \
              --clientid ${{ secrets.SF_CLIENT_ID }} \
              --jwtkeyfile server.key \
              --username ${{ secrets.SF_USERNAME_QA }} \
              --instanceurl https://login.salesforce.com \
              --setalias QA
          fi

      - name: Detect changed component folders
        id: changes
        run: |
          echo "Changed folders:"
          git diff --name-only HEAD^ HEAD | grep "^force-app" | cut -d'/' -f1-5 | sort -u > changed-folders.txt || true
          cat changed-folders.txt

      - name: Deploy changed components
        run: |
          if [ -s changed-folders.txt ]; then
            echo "Deploying changed folders..."
            while read folder; do
              echo "Deploying $folder"
              sf project deploy start \
                --source-dir "$folder" \
                --target-org QA \
                --ignore-conflicts \
                --wait 10
            done < changed-folders.txt

          else
            echo "No deployable changes found. Skipping deployment."
          fi

      # - name: Rollback commit by opening a PR if deployment fails
      #   if: failure()
      #   run: |
      #     echo "Deployment failed, creating rollback branch and PR..."

      #     git config --global user.name "github-actions[bot]"
      #     git config --global user.email "41898282+github-actions[bot]@users.noreply.githubcom"

      #     ROLLBACK_BRANCH="rollback-$(date +%s)"
      #     git checkout -b "$ROLLBACK_BRANCH" HEAD^

      #     git push origin "$ROLLBACK_BRANCH"

      #     echo "Installing GitHub CLI..."
      #     curl -sSL https://cli.github.com/install.sh | sh
      #     export PATH=$PATH:/usr/local/bin
      #     gh --version

      #     echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      #     gh pr create \
      #       --title "ðŸ” Rollback: Failed deployment from main" \
      #       --body "This PR reverts the latest commit on \`main\` due to a failed Salesforcedeployment." \
      #       --base main \
      #       --head "$ROLLBACK_BRANCH"

      # - name: Send rollback notification email
      #   if: failure()
      #   env:
      #     SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
      #     SMTP_PORT: ${{ secrets.SMTP_PORT }}
      #     EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      #     EMAIL_TO: ${{ secrets.EMAIL_TO }}
      #     EMAIL_USER: ${{ secrets.EMAIL_USER }}
      #     EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      #     GITHUB_REPO: ${{ github.repository }}
      #     GITHUB_SHA: ${{ github.sha }}
      #   run: |
      #     echo "Downloading mailsend-go..."
      #     curl -L -o mailsend-go.tar.gz https://github.com/muquit/mailsend-go/releases/download/v1.0.6/mailsend-go-linux-amd64.tar.gz
      #     tar -xzf mailsend-go.tar.gz
      #     chmod +x mailsend-go/mailsend-go

      #     PR_URL="${{ steps.rollback_pr.outputs.pr_url || 'Rollback PR URL not available' }}"

      #     MESSAGE="ðŸš¨ Salesforce deployment to QA failed for commit: https://github.com/$GITHUB_REPO/commit/$GITHUB_SHA

      #     A rollback PR has been created: $PR_URL

      #     Please review and merge the rollback as needed."

      #     ./mailsend-go/mailsend-go \
      #       -smtp "$SMTP_SERVER" \
      #       -port "$SMTP_PORT" \
      #       -auth \
      #       -user "$EMAIL_USER" \
      #       -pass "$EMAIL_PASS" \
      #       -from "$EMAIL_FROM" \
      #       -to "$EMAIL_TO" \
      #       -sub "âŒ Salesforce Deployment Failed â€“ Rollback PR Created" \
      #       -M "$MESSAGE"

  # - name: Detect changed metadata files
  #   id: changes
  #   run: |
  #     echo "Changed files:"
  #     git diff --name-only HEAD^ HEAD | grep "^force-app" > changed-files.txt || true
  #     cat changed-files.txt

  # - name: Deploy changed files (if any)
  #   if: success() && steps.changes.outputs != ''
  #   run: |
  #     CHANGED_FILES=$(cat changed-files.txt | tr '\n' ',' | sed 's/,$//')
  #     if [ -z "$CHANGED_FILES" ]; then
  #       echo "No deployable changes found. Skipping deploy."
  #     else
  #       echo "Deploying: $CHANGED_FILES"
  #       sf project deploy start \
  #         --source-dir $CHANGED_FILES \
  #         --target-org QA \
  #         --ignore-conflicts \
  #         --wait 10
  #     fi
